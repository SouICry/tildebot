const Firestore = require('@google-cloud/firestore');
const db = new Firestore({
  projectId: "tilde-323223",
  keyFilename: 'k.json',
});
const admin = require('firebase-admin');
const FieldValue = admin.firestore.FieldValue;

require('dotenv').config();
const { Client, Intents, Options } = require('discord.js');
const client = new Client({
  intents: [Intents.FLAGS.GUILDS, Intents.FLAGS.GUILD_MESSAGES, Intents.FLAGS.DIRECT_MESSAGES],
  makeCache: Options.cacheWithLimits({
    ...Options.defaultMakeCacheSettings,
    MessageManager: 400,
  })
})


const milliPerWeek = 7 * 24 * 60 * 60 * 1000;
let weekStartTimeMillis, weekStart, prevWeekStartTimeMillis, prevWeekStrings, prevWeekPointStrings, prevWeekFlagStrings,
  weekPointString, weekFlagString;

function getWeekStartTimeMillis() {
  const d = new Date();
  let day = d.getUTCDay();
  if (day == 0) {
    day = 7;
  }
  day--;
  return d.getTime() - ((((day * 24 + d.getUTCHours()) * 60 +
    d.getUTCMinutes()) * 60 + d.getUTCSeconds()) * 1000 + d.getUTCMilliseconds())
}

function updateWeekStart() {
  weekStartTimeMillis = getWeekStartTimeMillis();
  weekStart = new Date(weekStartTimeMillis).toISOString()
  weekPointString = weekStart + ` Points`;
  weekFlagString = weekStart + ` Flag`;
  console.log('Week start: ' + weekStart);

  prevWeekStartTimeMillis = [weekStartTimeMillis - milliPerWeek];
  for (let i = 0; i < 2; i++) {
    prevWeekStartTimeMillis.push(prevWeekStartTimeMillis[i] - milliPerWeek);
  }
  prevWeekStrings = prevWeekStartTimeMillis.map(t => new Date(t).toISOString())
  prevWeekPointStrings = prevWeekStrings.map(t => t + ` Points`);
  prevWeekFlagStrings = prevWeekStrings.map(t => t + ` Flag`);
}

updateWeekStart();
console.log(prevWeekPointStrings);
console.log(prevWeekFlagStrings);

const ids = JSON.parse('["593803427906322433","744024287794561054","448365963528634368","108759575297052672","81980303073083392","188197279822381056","113473785348231168","298673399230758914","204789334023340032","103718711105421312","387115558744883204","207422506989125632","538059759438528517","313220656084811786","89208882697617408","120431037388947456","217509815474192384","660307320055791636","184029195519655936","295449058930327554","254038463463030784","386695975399587841","165207884077072385","174406589854384129","544298974274650117","253405226701160450","198531163919351808","202908317725622272","681958022041567261","147838346360651776","308085536176865280","753447291079229530","447624082469683202","215610046732697601","744284134699958283","187298758348767233","123155829988786176","97051535699091456","150844975947448320","176501648632315904","173543058883739650","390578775546658816","127868141513474048","368795239483310081","321198178902999040","210965205134475265","373320372604633088","185956056546017290","92732477512101888","746518680359272559","265710806912466946","278705120789921794","382785958665519104","190320532707737600","621542965520629790"]'
);




// const prev = prevWeekPointStrings[0];
// const f = async () => {
//   let p = []
//   ids.forEach(async (id) => {
//     p.push(db.collection('points').doc(id).set({
//       gpq: FieldValue.arrayRemove(weekStart)
//     }, { merge: true }));
//     p.push(db.collection('points').doc(id).set({
//       gpq: FieldValue.arrayUnion(prevWeekStrings[0])
//     }, { merge: true }));
//     console.log(id);
//   });
//   await Promise.all(p);
//   console.log('done');
// }
// f();



a = JSON.parse('[["198531163919351808","1531900"],["669679751199326249","1450250"],["108759575297052672","1355550"],["390578775546658816","1061800"],["544298974274650117","1035250"],["103718711105421312","1015100"],["147838346360651776","836200"],["81980303073083392","835550"],["235264835200352256","835250"],["546785621012774912","820000"],["475342909986570240","793450"],["190320532707737600","775600"],["278705120789921794","731440"],["217509815474192384","729750"],["187298758348767233","725900"],["207422506989125632","703800"],["681958022041567261","690700"],["185956056546017290","640740"],["113473785348231168","640000"],["151824681698197504","620600"],["120431037388947456","615750"],["401212793115901952","581000"],["382785958665519104","563400"],["368795239483310081","542100"],["705754573339623476","515100"],["188197279822381056","503300"],["386695975399587841","502800"],["280307509628108802","499550"],["660307320055791636","480000"],["184029195519655936","448250"],["321198178902999040","440350"],["538059759438528517","440000"],["447624082469683202","438250"],["253405226701160450","427300"],["276149771834753024","426300"],["150844975947448320","419150"],["215610046732697601","408050"],["373329305058410517","399200"],["129789233404575744","398850"],["167528079600648193","396400"],["336346445646921732","373650"],["667414458339164181","371100"],["746518680359272559","368200"],["274148944416866304","362100"],["214563338116399104","342089"],["176895074913746944","340000"],["210965205134475265","322350"],["230452234893262851","303900"],["204789334023340032","293500"],["219630406209634305","287200"],["586665601905197066","280000"],["311261053197615114","280000"],["536023738924269579","280000"],["230423168026673153","280000"],["665785670559727617","280000"],["183401747971178505","278150"],["207047585800781824","277200"],["700915328619642911","252700"],["242430489540034563","246600"],["127868141513474048","232900"],["254038463463030784","223900"],["199326581544452096","220000"],["598692509333585922","220000"],["476328982112108544","220000"],["322618881585709056","207500"],["208779108358815746","206300"],["142377217190526976","201500"],["477825938906808321","192400"],["128213304916049920","186000"],["328036883303235585","182000"],["243941030959775746","180000"],["423299020795019265","179200"],["165207884077072385","177700"],["584421679359590401","163450"],["313220656084811786","160000"],["433722341667766292","141200"],["298673399230758914","140000"],["387115558744883204","140000"],["404765247153373204","139800"],["174406589854384129","134900"],["235849788900376587","128450"],["202908317725622272","123600"],["696160491780964424","121200"],["105875328546689024","120000"],["417281000368898049","120000"],["176501648632315904","120000"],["265710806912466946","120000"],["212971210005282816","113800"],["404633572767432706","101500"],["262036238045937664","100300"],["408177089997570055","100000"],["123155829988786176","100000"],["659032048408985610","88800"],["282740162725937153","80000"],["328385377725579264","80000"],["339770090880892929","80000"],["593803427906322433","78450"],["744024287794561054","77100"],["158453090507292672","69000"],["97051535699091456","60600"],["257318959638904833","60000"],["528014180142415902","60000"],["237001432832671744","60000"],["448365963528634368","60000"],["261233301837185034","60000"],["753447291079229530","60000"],["123969386305421313","40300"],["520867846096551936","40000"],["238128347505229824","40000"],["295449058930327554","40000"],["221196470605447168","26000"],["178763270654656513","25850"],["761831526233014292","25100"],["621542965520629790","24650"],["274471992512610304","20000"],["213265940383662080","20000"],["125825194676846593","20000"],["204821750897180672","20000"],["308085536176865280","20000"],["92732477512101888","20000"],["700475420402909305","20000"],["195461452910297088","11850"],["355984109631307776","11250"],["695935439965650977","11250"],["280096430356430848","3000"],["660778448465166336","3000"],["368678600607531008","1950"],["241063815855341571","0"]]'
);
p = [];
a.forEach(arr => {
  p.push(db.collection('points').doc(arr[0]).set({
    totalPoints: FieldValue.increment(parseInt(arr[1], 10)),
  }, { merge: true }));
}
)





